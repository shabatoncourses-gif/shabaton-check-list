import React, { useState, useEffect } from 'react';
import { Plus, Trash2, CheckCircle2, Circle, ListTodo, Save, RefreshCw, ExternalLink } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, getDoc } from 'firebase/firestore';

// הגדרות Firebase
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'shabaton-shared-v3';

// רשימת המשימות המקורית מהמדריך
const INITIAL_PHASES = [
  { 
    name: "שלב א': ההכנות (ינואר-אוגוסט)", 
    tasks: [
      { id: 'a1', text: "בדיקת זכאות והפקת אישור", link: "https://www.shabaton.online/luz_shabaton#1080507921" },
      { id: 'a2', text: "בקשת חל\"ת מהמעסיק (עד 31.3)", link: "https://www.shabaton.online/luz_shabaton#request" },
      { id: 'a3', text: "חתימה על טופס 1 (פרטים וחשבון בנק)", link: "https://www.shabaton.online/document-submission" },
      { id: 'a4', text: "הגשת תוכנית לימודים - טופס 2", link: "https://www.shabaton.online/study-plan-submission" }
    ]
  },
  { 
    name: "שלב ב': במהלך השבתון (ספטמבר-אפריל)", 
    tasks: [
      { id: 'b1', text: "החזר שכר לימוד ודיווח עבודה", link: "https://www.shabaton.online/tuition-refund" },
      { id: 'b2', text: "הסדרת ביטוח לאומי ומס בריאות", link: "https://www.shabaton.online/national-insurance" },
      { id: 'b3', text: "בקשת החזרי מס (טופס 135)", link: "https://www.shabaton.online/tax-refund" },
      { id: 'b4', text: "הודעת חזרה לעבודה (עד 31.3)", link: "https://www.shabaton.online/return-to-work" }
    ]
  },
  { 
    name: "שלב ג': סיום השבתון (מאי-אוגוסט)", 
    tasks: [
      { id: 'c1', text: "משלוח קבלות מקוריות לבנק (עד 15.8)", link: "https://www.shabaton.online/receipt-submission" }
    ]
  }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [taskStates, setTaskStates] = useState({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // שלב 1: אימות
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        setError("שגיאת התחברות למערכת");
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // שלב 2: סנכרון נתונים
  useEffect(() => {
    if (!user) return;

    // נתיב מוגן לפי חוקי הסביבה
    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'userStates', user.uid);
    
    const unsubscribe = onSnapshot(userDocRef, (snapshot) => {
      if (snapshot.exists()) {
        setTaskStates(snapshot.data().states || {});
      }
      setLoading(false);
    }, (err) => {
      console.error(err);
      setError("שגיאת הרשאות בגישה לנתונים");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const toggleTask = async (taskId) => {
    if (!user) return;
    const newStates = { ...taskStates, [taskId]: !taskStates[taskId] };
    setTaskStates(newStates);

    try {
      const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'userStates', user.uid);
      await setDoc(userDocRef, { states: newStates, lastUpdated: Date.now() }, { merge: true });
    } catch (err) {
      setError("הסנכרון נכשל");
    }
  };

  const calculateProgress = () => {
    const allTasks = INITIAL_PHASES.flatMap(p => p.tasks);
    const completedCount = allTasks.filter(t => taskStates[t.id]).length;
    return Math.round((completedCount / allTasks.length) * 100);
  };

  if (loading) {
    return (
      <div className="flex h-screen items-center justify-center bg-slate-50 font-sans" dir="rtl">
        <RefreshCw className="text-teal-600 animate-spin" size={32} />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans" dir="rtl">
      <div className="max-w-2xl mx-auto">
        
        {/* Header & Progress */}
        <div className="bg-white rounded-3xl p-8 shadow-sm mb-6 border border-slate-200">
          <div className="flex justify-between items-center mb-6">
            <div className="flex items-center gap-3">
              <div className="bg-teal-600 p-2.5 rounded-xl text-white">
                <ListTodo size={24} />
              </div>
              <h1 className="text-2xl font-black text-slate-800">הצ'ק-ליסט שלי לשבתון</h1>
            </div>
            <div className="text-left">
               <span className="text-xs font-bold text-slate-400 uppercase tracking-tighter block">התקדמות</span>
               <span className="text-2xl font-black text-teal-600">{calculateProgress()}%</span>
            </div>
          </div>

          <div className="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
            <div 
              className="bg-teal-500 h-full transition-all duration-500" 
              style={{ width: `${calculateProgress()}%` }}
            ></div>
          </div>

          {error && (
            <div className="mt-4 p-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold border border-red-100 text-center">
              {error}
            </div>
          )}
        </div>

        {/* Phases */}
        <div className="space-y-8">
          {INITIAL_PHASES.map((phase, pIdx) => (
            <div key={pIdx} className="space-y-3">
              <h2 className="text-sm font-black text-teal-700 bg-teal-50 inline-block px-3 py-1 rounded-lg uppercase">
                {phase.name}
              </h2>
              <div className="grid gap-3">
                {phase.tasks.map((task) => {
                  const isDone = taskStates[task.id];
                  return (
                    <div
                      key={task.id}
                      className={`flex items-center justify-between p-4 rounded-2xl transition-all border cursor-pointer ${
                        isDone 
                          ? 'bg-slate-50 border-slate-100' 
                          : 'bg-white border-slate-200 hover:border-teal-300 shadow-sm'
                      }`}
                      onClick={() => toggleTask(task.id)}
                    >
                      <div className="flex items-center gap-4 flex-1">
                        {isDone ? (
                          <div className="bg-teal-500 rounded-full p-1"><CheckCircle2 className="text-white" size={18} /></div>
                        ) : (
                          <Circle className="text-slate-300" size={24} />
                        )}
                        <div className="flex flex-col">
                          <span className={`font-bold transition-all ${
                            isDone ? 'text-slate-400 line-through' : 'text-slate-700'
                          }`}>
                            {task.text}
                          </span>
                          <a 
                            href={task.link} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-[10px] text-teal-600 font-black hover:underline mt-1 flex items-center gap-1"
                            onClick={(e) => e.stopPropagation()}
                          >
                            מדריך מלא <ExternalLink size={10} />
                          </a>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>

        <footer className="mt-12 text-center text-slate-400 text-xs pb-8">
          המידע מסונכרן אוטומטית למסד הנתונים
        </footer>
      </div>
    </div>
  );
}
