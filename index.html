import React, { useState, useEffect } from 'react';
import { 
  Plus, Trash2, CheckCircle2, Circle, ListTodo, 
  Settings2, X, ExternalLink, Save, Loader2, 
  Users, ChevronRight, BarChart3, Clock
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, getDocs } from 'firebase/firestore';

// Firebase Config
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'shabaton-manager-v1';

const DEFAULT_PHASES = [
  { 
    name: "שלב א': ההכנות (ינואר-אוגוסט)", 
    tasks: [
      { id: 'a1', text: "בדיקת זכאות והפקת אישור", link: "https://www.shabaton.online/luz_shabaton#1080507921" },
      { id: 'a2', text: "בקשת חל\"ת מהמעסיק (עד 31.3)", link: "https://www.shabaton.online/luz_shabaton#request" },
      { id: 'a3', text: "חתימה על טופס 1", link: "https://www.shabaton.online/document-submission" },
      { id: 'a4', text: "הגשת תוכנית לימודים - טופס 2", link: "https://www.shabaton.online/study-plan-submission" }
    ]
  },
  { 
    name: "שלב ב': במהלך השבתון", 
    tasks: [
      { id: 'b1', text: "החזר שכר לימוד ודיווח עבודה", link: "https://www.shabaton.online/tuition-refund" },
      { id: 'b2', text: "הסדרת ביטוח לאומי ומס בריאות", link: "https://www.shabaton.online/national-insurance" }
    ]
  }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('user'); // 'user' or 'admin'
  const [phases, setPhases] = useState(DEFAULT_PHASES);
  const [taskStates, setTaskStates] = useState({});
  const [allUsersData, setAllUsersData] = useState([]);
  const [isEditMode, setIsEditMode] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [newTaskText, setNewTaskText] = useState("");
  const [activePhaseIndex, setActivePhaseIndex] = useState(null);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        setError("שגיאה בחיבור");
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // User Data Sync
  useEffect(() => {
    if (!user || view !== 'user') return;

    const dataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklistData', user.uid);
    const unsubscribe = onSnapshot(dataDocRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.data();
        if (data.phases) setPhases(data.phases);
        if (data.taskStates) setTaskStates(data.taskStates);
      } else {
        saveToCloud(DEFAULT_PHASES, {});
      }
      setLoading(false);
    }, (err) => {
      setError("שגיאת סנכרון");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user, view]);

  // Admin Data Fetch
  useEffect(() => {
    if (view !== 'admin' || !user) return;
    setLoading(true);
    
    const usersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklistData');
    const unsubscribe = onSnapshot(usersColRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setAllUsersData(data);
      setLoading(false);
    }, (err) => {
      setError("אין הרשאות לצפייה בנתוני משתמשים");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [view, user]);

  const saveToCloud = async (updatedPhases, updatedStates) => {
    if (!user) return;
    try {
      const dataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklistData', user.uid);
      await setDoc(dataDocRef, {
        phases: updatedPhases,
        taskStates: updatedStates,
        lastUpdated: Date.now(),
        userId: user.uid
      }, { merge: true });
    } catch (err) {
      console.error(err);
    }
  };

  const calculateProgress = (phasesArr, statesObj) => {
    const allTasks = phasesArr.flatMap(p => p.tasks);
    if (allTasks.length === 0) return 0;
    const completedCount = allTasks.filter(t => statesObj[t.id]).length;
    return Math.round((completedCount / allTasks.length) * 100);
  };

  const toggleTask = (taskId) => {
    if (isEditMode) return;
    const newStates = { ...taskStates, [taskId]: !taskStates[taskId] };
    setTaskStates(newStates);
    saveToCloud(phases, newStates);
  };

  const addTask = (phaseIdx) => {
    if (!newTaskText.trim()) return;
    const updatedPhases = [...phases];
    updatedPhases[phaseIdx].tasks.push({
      id: `custom-${Date.now()}`,
      text: newTaskText,
      link: ""
    });
    setPhases(updatedPhases);
    setNewTaskText("");
    setActivePhaseIndex(null);
    saveToCloud(updatedPhases, taskStates);
  };

  const AdminPanel = () => (
    <div className="animate-in fade-in duration-500">
      <div className="flex items-center justify-between mb-8">
        <button onClick={() => setView('user')} className="flex items-center gap-2 text-teal-600 font-bold hover:bg-teal-50 px-3 py-2 rounded-xl transition-colors">
          <ChevronRight size={20} /> חזרה לצ'ק-ליסט שלי
        </button>
        <h1 className="text-2xl font-black text-slate-800">ניהול משתמשים</h1>
      </div>

      <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
        <table className="w-full text-right border-collapse">
          <thead>
            <tr className="bg-slate-50 border-b border-slate-200">
              <th className="p-4 text-slate-500 font-bold text-sm">משתמש (UID)</th>
              <th className="p-4 text-slate-500 font-bold text-sm text-center">התקדמות</th>
              <th className="p-4 text-slate-500 font-bold text-sm">עדכון אחרון</th>
              <th className="p-4 text-slate-500 font-bold text-sm text-center">סטטוס</th>
            </tr>
          </thead>
          <tbody>
            {allUsersData.map((u) => (
              <tr key={u.id} className="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                <td className="p-4 font-mono text-xs text-slate-500">{u.id}</td>
                <td className="p-4">
                  <div className="flex items-center justify-center gap-3">
                    <div className="w-24 bg-slate-100 h-2 rounded-full overflow-hidden">
                      <div 
                        className="bg-teal-500 h-full" 
                        style={{ width: `${calculateProgress(u.phases || DEFAULT_PHASES, u.taskStates || {})}%` }}
                      ></div>
                    </div>
                    <span className="font-bold text-teal-600 text-sm">
                      {calculateProgress(u.phases || DEFAULT_PHASES, u.taskStates || {})}%
                    </span>
                  </div>
                </td>
                <td className="p-4 text-slate-600 text-xs">
                  {u.lastUpdated ? new Date(u.lastUpdated).toLocaleString('he-IL') : '---'}
                </td>
                <td className="p-4 text-center">
                  {calculateProgress(u.phases || DEFAULT_PHASES, u.taskStates || {}) === 100 ? (
                    <span className="bg-green-100 text-green-700 px-2 py-1 rounded-md text-[10px] font-bold">הושלם</span>
                  ) : (
                    <span className="bg-amber-100 text-amber-700 px-2 py-1 rounded-md text-[10px] font-bold">בתהליך</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        {allUsersData.length === 0 && (
          <div className="p-10 text-center text-slate-400 font-medium">לא נמצאו משתמשים רשומים</div>
        )}
      </div>
    </div>
  );

  if (loading) {
    return <div className="flex h-screen items-center justify-center bg-slate-50" dir="rtl"><Loader2 className="text-teal-600 animate-spin" size={40} /></div>;
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-right" dir="rtl">
      <div className="max-w-4xl mx-auto">
        
        {view === 'admin' ? (
          <AdminPanel />
        ) : (
          <>
            {/* Header */}
            <div className="bg-white rounded-3xl p-6 md:p-10 shadow-sm mb-8 border border-slate-200 relative">
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div className="flex items-center gap-4">
                  <div className="bg-teal-600 p-3 rounded-2xl text-white"><ListTodo size={28} /></div>
                  <div>
                    <h1 className="text-2xl md:text-3xl font-black text-slate-800">הצ'ק-ליסט שלי</h1>
                    <p className="text-slate-500 text-xs">מזהה משתמש: {user?.uid}</p>
                  </div>
                </div>

                <div className="flex items-center gap-2 flex-wrap">
                  <button 
                    onClick={() => setView('admin')}
                    className="flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-black transition-all"
                  >
                    <Users size={18} /> ניהול משתמשים
                  </button>
                  <button 
                    onClick={() => setIsEditMode(!isEditMode)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-sm border transition-all ${
                      isEditMode ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
                    }`}
                  >
                    <Settings2 size={18} /> {isEditMode ? "סיום עריכה" : "עריכת משימות"}
                  </button>
                </div>
              </div>

              <div className="mt-8 flex items-center gap-4">
                 <div className="flex-1 bg-slate-100 h-3 rounded-full overflow-hidden">
                    <div className="bg-teal-500 h-full transition-all duration-700" style={{ width: `${calculateProgress(phases, taskStates)}%` }}></div>
                 </div>
                 <span className="font-black text-teal-600">{calculateProgress(phases, taskStates)}%</span>
              </div>
            </div>

            {/* Checklist */}
            <div className="space-y-8">
              {phases.map((phase, pIdx) => (
                <div key={pIdx}>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-lg font-black text-slate-700 pr-2 border-r-4 border-teal-500 mr-2">{phase.name}</h2>
                    {isEditMode && (
                      <button onClick={() => setActivePhaseIndex(activePhaseIndex === pIdx ? null : pIdx)} className="p-1 bg-teal-600 text-white rounded-lg"><Plus size={16}/></button>
                    )}
                  </div>
                  
                  {isEditMode && activePhaseIndex === pIdx && (
                    <div className="mb-4 flex gap-2">
                      <input 
                        type="text" value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)}
                        placeholder="משימה חדשה..." className="flex-1 p-2 rounded-lg border text-sm"
                        onKeyPress={(e) => e.key === 'Enter' && addTask(pIdx)}
                      />
                      <button onClick={() => addTask(pIdx)} className="bg-teal-600 text-white px-4 rounded-lg text-sm font-bold">הוספה</button>
                    </div>
                  )}

                  <div className="grid gap-2">
                    {phase.tasks.map((task, tIdx) => (
                      <div key={task.id} onClick={() => toggleTask(task.id)} className={`flex items-center justify-between p-4 rounded-2xl border transition-all ${isEditMode ? '' : 'cursor-pointer'} ${taskStates[task.id] ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-200 shadow-sm'}`}>
                        <div className="flex items-center gap-3">
                          {!isEditMode && (taskStates[task.id] ? <CheckCircle2 className="text-teal-500" size={20}/> : <Circle className="text-slate-300" size={20}/>)}
                          <span className={`font-bold text-sm ${taskStates[task.id] ? 'line-through text-slate-400' : 'text-slate-700'}`}>{task.text}</span>
                        </div>
                        {isEditMode && <button onClick={(e) => { e.stopPropagation(); /* delete logic */ }} className="text-red-300"><Trash2 size={16}/></button>}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </>
        )}

        <footer className="mt-12 text-center text-slate-400 text-[10px] font-bold pb-10">מערכת בקרה מרכזית • שבתון 2026</footer>
      </div>
    </div>
  );
}
